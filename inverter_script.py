#!/usr/bin/env python
import os
from classes.ptm import Ptm

def main():
    os.system('module add apps/synopsys/hspice/F-2011.09-SP2')

    # For the given path, get the full path list of transistors models
    dir_name = '/work_bgfs/i/iliabautista/2-Research/2-Simulations/1-HDL/hspice/modelfiles/'

    temp = Ptm("test", "nfet.pm", "pfet.pm")

    models_subdirs = temp.set_fet_names(dir_name)
    models_list = temp.get_models_libs()
    subdir_paths = temp.set_uut_dir(dir_name) # create uut directories and sbudirs

    #temp.set_fet_subckts(subdir_paths) # create fet subckt in subdirs

    nfin = 1000

    for model_subdir in models_subdirs:
        parts = model_subdir.split("/")
        parts.reverse()
        parts = "".join(parts)
        subuut = [subuut_name for subuut_name in models_list if parts in subuut_name] 
        with open(os.getcwd() + "/" + temp.uut + "/" + subuut[0] + ".sp", 'w+') as uut:
            (fet_size, fet_voltage) = temp.get_fet_params(model_subdir)

            uut.write("$This UUT was automatically generated by:\n")
            uut.write("$" + os.getcwd() + "/" + __file__ + "\n\n")

            uut.write("$Netlist of " + temp.uut + "\n")
            uut.write(".lib '../models' " + subuut[0] + "\n\n")

            uut.write("$FETs" + "\n")
            uut.write("xpfet" + "1" + " out in vdd vdd pfet l=" + fet_size + "n nfin=" + str(nfin) + "m\n")
            uut.write("xnfet" + "1" + " out in gnd gnd nfet l=" + fet_size + "n nfin=" + str(nfin) + "m\n\n")

            uut.write("$Output Load\n")
            uut.write("c" + "1" + " out 0 5f\n\n")

            uut.write("$Power Sources\n")
            uut.write("vdd vdd gnd " + fet_voltage + "V\n")
            uut.write("vin in  gnd  PULSE(0V " + fet_voltage + "V 0ns 50ps 50ps 1ns 20ns)\n\n")
            
            uut.write(".option post=2\n\n")
            
            uut.write("$Analysis\n")
            uut.write(".tran 10ps 4ns\n\n")

            uut.write(".end")


        uut_script_dir = os.getcwd()
        os.chdir(temp.uut)
        os.system('hspice ' + subuut[0] + ".sp")
        os.chdir(uut_script_dir)
#       print(temp.uut)

if __name__ == '__main__':
    main()

